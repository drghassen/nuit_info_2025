{% extends 'iot/base.html' %}
{% load static %}

{% block title %}EcoTrack • Énergie{% endblock %}

{% block content %}
<div class="text-center mb-5">
    <h1 class="display-5 fw-bold mb-3">Données <span class="text-warning">Énergétiques</span></h1>
    <p class="lead opacity-80">Consommation, émissions CO₂, surchauffe et activité des appareils</p>
</div>

<div class="row g-4 mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="glass-card p-4 text-center">
            <i class="fas fa-plug fa-2x text-warning mb-3"></i>
            <p class="mb-1 opacity-75">Puissance Moyenne</p>
            <h3 class="metric-big text-warning" id="avg-power">-</h3>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="glass-card p-4 text-center">
            <i class="fas fa-cloud fa-2x text-danger mb-3"></i>
            <p class="mb-1 opacity-75">CO₂ Moyen</p>
            <h3 class="metric-big text-danger" id="avg-co2">-</h3>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="glass-card p-4 text-center">
            <i class="fas fa-thermometer-half fa-2x text-warning mb-3"></i>
            <p class="mb-1 opacity-75">Surchauffe</p>
            <h3 class="metric-big text-warning" id="avg-overheating">-</h3>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="glass-card p-4 text-center">
            <i class="fas fa-desktop fa-2x text-success mb-3"></i>
            <p class="mb-1 opacity-75">Appareils Actifs</p>
            <h3 class="metric-big text-success" id="avg-active">-</h3>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-lg-6">
        <div class="chart-container glass-card">
            <h5 class="mb-3"><i class="fas fa-plug me-2 text-warning"></i>Consommation Électrique</h5>
            <canvas id="powerChart"></canvas>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="chart-container glass-card">
            <h5 class="mb-3"><i class="fas fa-cloud me-2 text-danger"></i>Émissions CO₂</h5>
            <canvas id="co2Chart"></canvas>
        </div>
    </div>
</div>
<div class="row g-4 mb-5">
    <div class="col-lg-6">
        <div class="chart-container glass-card">
            <h5 class="mb-3"><i class="fas fa-thermometer-half me-2 text-warning"></i>Niveau de Surchauffe</h5>
            <canvas id="overheatingChart"></canvas>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="chart-container glass-card">
            <h5 class="mb-3"><i class="fas fa-desktop me-2 text-success"></i>Appareils Actifs</h5>
            <canvas id="activeDevicesChart"></canvas>
        </div>
    </div>
</div>

<div class="glass-card overflow-hidden">
    <div class="p-4 border-bottom border-white border-opacity-10">
        <h4 class="mb-0"><i class="fas fa-table me-2 text-primary"></i>Dernières Données Énergétiques</h4>
    </div>
    <div class="table-responsive">
        <table class="table table-custom table-hover mb-0">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Sensor ID</th>
                    <th>Puissance (W)</th>
                    <th>CO₂ (g)</th>
                    <th>Surchauffe</th>
                    <th>Appareils Actifs</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody id="data-table-body">
                {% for data in latest_data %}
                <tr>
                    <td>{{ data.id }}</td>
                    <td>{{ data.energy_sensor_id }}</td>
                    <td>{{ data.power_watts }}W</td>
                    <td>{{ data.co2_equiv_g }}g</td>
                    <td><span class="badge {% if data.overheating > 80 %}bg-danger{% elif data.overheating > 60 %}bg-warning{% else %}bg-success{% endif %}">{{ data.overheating }}°C</span></td>
                    <td>{{ data.active_devices }}</td>
                    <td>{{ data.created_at|date:"d/m/Y H:i" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center py-5 opacity-50">Aucune donnée disponible</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Données pour JavaScript (cachées) -->
<script type="application/json" id="chart-labels-data">{{ chart_labels|safe }}</script>
<script type="application/json" id="power-data">{{ power_data|safe }}</script>
<script type="application/json" id="co2-data">{{ co2_data|safe }}</script>
<script type="application/json" id="overheating-data">{{ overheating_data|safe }}</script>
<script type="application/json" id="active-devices-data">{{ active_devices_data|safe }}</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/energy.js' %}"></script>
{% endblock %}
