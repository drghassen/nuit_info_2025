{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoTrack ‚Ä¢ Dashboard IoT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/common.css' %}">
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <style>
        .welcome-banner {
            position: relative;
        }

        .welcome-content {
            position: relative;
            z-index: 2;
        }

        .welcome-icon {
            animation: floatIcon 3s ease-in-out infinite;
        }

        @keyframes floatIcon {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .welcome-title {
            background: linear-gradient(45deg, #e2e8f0, #f1f5f9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
        }

        .welcome-subtitle {
            font-size: 1rem;
            color: rgba(226, 232, 240, 0.9);
        }

        .welcome-badges {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .badge-professional {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(67, 97, 238, 0.2));
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #e2e8f0;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            backdrop-filter: blur(10px);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .badge-professional i {
            opacity: 0.8;
        }

        /* Session management */
        .session-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(67, 97, 238, 0.3);
            border-radius: 12px;
            padding: 1rem;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 300px;
        }

        .session-info.hidden {
            display: none;
        }

        .session-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .session-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #e2e8f0;
        }

        .session-close {
            background: none;
            border: none;
            color: rgba(226, 232, 240, 0.6);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .session-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
        }

        .session-details {
            font-size: 0.8rem;
            color: rgba(226, 232, 240, 0.7);
            line-height: 1.4;
        }

        .session-timer {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.75rem;
            color: rgba(226, 232, 240, 0.5);
        }

        /* Security features */
        .security-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #10b981, #4361ee);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .security-indicator:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 48px rgba(16, 185, 129, 0.4);
        }

        .security-indicator i {
            color: white;
            font-size: 1.2rem;
        }

        /* Professional auth system styles */
        .auth-professional {
            position: relative;
        }

        .auth-professional::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(16, 185, 129, 0.05), rgba(67, 97, 238, 0.05));
            border-radius: 20px;
            z-index: -1;
        }

        @media (max-width: 768px) {
            .welcome-badges {
                flex-direction: column;
                align-items: center;
            }

            .badge-professional {
                margin-bottom: 0.5rem;
            }

            .session-info {
                top: 10px;
                right: 10px;
                left: 10px;
                right: auto;
                max-width: none;
                width: calc(100% - 20px);
            }

            .security-indicator {
                bottom: 10px;
                right: 10px;
                width: 45px;
                height: 45px;
            }

            .security-indicator i {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body class="text-light">
    <!-- Container pour les mini-toasts -->
    <div class="notifications-container-top" id="miniToastsContainer"></div>
    
    <!-- Panneau des notifications -->
    <div class="notifications-panel-navbar" id="notificationsPanel">
        <div class="notifications-header">
            <div class="notifications-title">Notifications</div>
            <div class="notifications-count" id="notificationCount">0</div>
        </div>
        <div class="notifications-list" id="notificationsList">
            <!-- Les notifications seront ajout√©es ici -->
        </div>
        <div class="notifications-footer">
            <button class="clear-all-btn" id="clearAllBtn">Marquer tout comme lu</button>
        </div>
    </div>

    <!-- Chatbot Container -->
    <div class="chatbot-container" id="chatbotContainer">
        <div class="chatbot-header">
            <div class="chatbot-title">
                <i class="fas fa-robot me-2"></i>Assistant IA EcoTrack
            </div>
            <button class="chatbot-close" id="chatbotClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chatbot-messages" id="chatbotMessages">
            <div class="message bot">
                Bonjour ! Je suis votre assistant IA EcoTrack. Comment puis-je vous aider aujourd'hui ?
            </div>
        </div>
        <div class="suggestions">
            <button class="suggestion-btn" data-question="C'est quoi le projet NIRD ?">
                Qu'est-ce que le projet NIRD ?
            </button>
            <button class="suggestion-btn" data-question="Comment r√©duire la consommation √©nerg√©tique ?">
                R√©duire consommation
            </button>
            <button class="suggestion-btn" data-question="Comment am√©liorer mon score √©cologique ?">
                Am√©liorer score √©co
            </button>
        </div>
        <div class="chatbot-input-container">
            <input type="text" class="chatbot-input" id="chatbotInput" 
                   placeholder="Posez votre question..." 
                   onkeypress="if(event.key === 'Enter') sendMessage()">
            <button class="chatbot-send" id="chatbotSend" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Structure principale -->
    <div class="main-layout">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar">
            <div class="brand">
                <i class="fas fa-leaf text-success fs-2"></i>
                <span class="label fw-bold">EcoTrack <span class="text-primary">IoT</span></span>
                <div id="sidebarToggle" class="sidebar-toggle"><i class="fas fa-angles-right"></i></div>
            </div>
            <ul class="nav-list">
                <li class="nav-item"><a href="{% url 'dashboard' %}" class="nav-link"><i class="fas fa-gauge-high"></i><span class="label">Dashboard</span></a></li>
                <li class="nav-item"><a href="{% url 'hardware' %}" class="nav-link"><i class="fas fa-microchip"></i><span class="label">Mat√©riel</span></a></li>
                <li class="nav-item"><a href="{% url 'energy' %}" class="nav-link"><i class="fas fa-bolt"></i><span class="label">√ânergie</span></a></li>
                <li class="nav-item"><a href="{% url 'network' %}" class="nav-link"><i class="fas fa-wifi"></i><span class="label">R√©seau</span></a></li>
                <li class="nav-item"><a href="{% url 'scores' %}" class="nav-link"><i class="fas fa-chart-bar"></i><span class="label">Scores</span></a></li>
                <li class="nav-item"><a href="{% url 'quiz' %}" class="nav-link"><i class="fas fa-circle-question"></i><span class="label">Quiz</span></a></li>
            </ul>
            <div class="px-3"><small class="text-secondary">v1.0</small></div>
        </aside>
        <!-- Contenu principal -->
        <div class="main-content-wrapper">
            <!-- Navbar -->
            <nav class="navbar navbar-expand-lg navbar-custom sticky-top">
                <div class="container-fluid px-4">
                    <a class="navbar-brand fw-bold fs-4" href="#">
                        <i class="fas fa-leaf text-success me-2"></i>EcoTrack <span class="text-primary">IoT</span>
                    </a>
                    <div class="d-flex align-items-center gap-4">
                        <div class="text-sm">
                            <i class="fas fa-clock text-warning me-2"></i>
                            Derni√®re mise √† jour : <span id="last-update" class="fw-semibold">00:00:00</span>
                        </div>
                        <div class="pulse">
                            <i class="fas fa-circle text-success fs-6"></i> Live
                        </div>

                        <!-- Bouton de d√©connexion -->
                        <a href="{% url 'logout' %}" class="btn btn-outline-danger btn-sm" title="Se d√©connecter">
                            <i class="fas fa-sign-out-alt me-1"></i>D√©connexion
                        </a>

                        <!-- Bouton Chatbot -->
                        <div class="chatbot-btn" id="chatbotBtn" title="Ouvrir l'assistant IA">
                            <i class="fas fa-robot"></i>
                        </div>

                        <!-- Bouton de notification -->
                        <div class="notification-btn-navbar" id="notificationBtn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                        </div>
                    </div>
                </div>
            </nav>
            <!-- Contenu -->
            <div class="container-fluid content-shift">
                <!-- Welcome Section - Affich√©e seulement apr√®s le login -->
                {% if show_welcome and user.is_authenticated %}
                <div class="welcome-banner mb-4" id="welcome-banner">
                    <div class="glass-card p-4 text-center">
                        <div class="welcome-content">
                            <div class="welcome-icon mb-3">
                                <i class="fas fa-user-circle fa-3x text-primary"></i>
                            </div>
                            <h2 class="welcome-title mb-2">
                                Bienvenue, <span class="text-primary">{{ user.get_full_name|default:user.username }}</span> ! üëã
                            </h2>
                            <p class="welcome-subtitle opacity-75 mb-0">
                                Connect√© en tant que <strong>{{ user.username }}</strong> ‚Ä¢ Session active
                            </p>
                            <div class="welcome-badges mt-3">
                                <span class="badge badge-professional">
                                    <i class="fas fa-shield-alt me-1"></i>Authentifi√©
                                </span>
                                <span class="badge badge-professional">
                                    <i class="fas fa-clock me-1"></i>Derni√®re connexion: {{ user.last_login|date:"d/m/Y H:i" }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Header -->
                <div class="text-center mb-5">
                    <h1 class="display-5 fw-bold mb-3">
                        Tableau de Bord <span class="text-primary">√âco-Responsable</span>
                    </h1>
                    <p class="lead opacity-80">Suivi en temps r√©el de l'impact environnemental de vos devices IoT</p>
                </div>
                <!-- Cat√©gories -->
                <div class="row g-4 mb-5">
                    <div class="col-md-3">
                        <div class="category-btn glass-card" data-category="hardware">
                            <i class="fas fa-microchip fa-2x mb-3 text-primary"></i>
                            <h5 class="fw-semibold">Mat√©riel</h5>
                            <small>CPU ‚Ä¢ RAM ‚Ä¢ Batterie</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="category-btn glass-card" data-category="energy">
                            <i class="fas fa-bolt fa-2x mb-3 text-warning"></i>
                            <h5 class="fw-semibold">√ânergie</h5>
                            <small>Puissance ‚Ä¢ Temp√©rature</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="category-btn glass-card" data-category="network">
                            <i class="fas fa-wifi fa-2x mb-3 text-info"></i>
                            <h5 class="fw-semibold">R√©seau</h5>
                            <small>Requ√™tes ‚Ä¢ Cloud</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="category-btn glass-card active">
                            <i class="fas fa-chart-bar fa-2x mb-3 text-success"></i>
                            <h5 class="fw-semibold">Scores √âco</h5>
                            <small>Impact ‚Ä¢ Obsolescence</small>
                        </div>
                    </div>
                </div>
                <!-- M√©triques principales -->
                <div class="row g-4 mb-5">
                    <div class="col-lg-3 col-md-6">
                        <div class="glass-card p-4 text-center">
                            <i class="fas fa-microchip fa-2x text-primary mb-3"></i>
                            <p class="mb-1 opacity-75">CPU Moyen</p>
                            <h3 class="metric-big text-primary" id="avg-cpu">--%</h3>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="glass-card p-4 text-center">
                            <i class="fas fa-memory fa-2x text-purple mb-3"></i>
                            <p class="mb-1 opacity-75">RAM Moyenne</p>
                            <h3 class="metric-big text-purple" id="avg-ram">--%</h3>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="glass-card p-4 text-center">
                            <i class="fas fa-bolt fa-2x text-warning mb-3"></i>
                            <p class="mb-1 opacity-75">Puissance</p>
                            <h3 class="metric-big text-warning" id="avg-power">-- W</h3>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="glass-card p-4 text-center">
                            <i class="fas fa-leaf fa-2x text-success mb-3"></i>
                            <p class="mb-1 opacity-75">Score √âco Global</p>
                            <h3 class="metric-big text-success" id="avg-eco">--</h3>
                        </div>
                    </div>
                </div>
                <!-- Graphiques -->
                <div class="row g-4 mb-5">
                    <div class="col-lg-6">
                        <div class="glass-card p-3">
                            <h5 class="mb-4"><i class="fas fa-brain me-2 text-primary"></i>CPU & RAM</h5>
                            <div class="chart-container">
                                <canvas id="cpuRamChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="glass-card p-3">
                            <h5 class="mb-4"><i class="fas fa-plug me-2 text-warning"></i>Consommation √ânerg√©tique</h5>
                            <div class="chart-container">
                                <canvas id="energyChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="glass-card p-3">
                            <h5 class="mb-4"><i class="fas fa-seedling me-2 text-success"></i>Score √âcologique</h5>
                            <div class="chart-container">
                                <canvas id="ecoChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="glass-card p-3">
                            <h5 class="mb-4"><i class="fas fa-smog me-2 text-danger"></i>√âmissions CO‚ÇÇ</h5>
                            <div class="chart-container">
                                <canvas id="co2Chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Tableau des derni√®res donn√©es -->
                <div class="glass-card mb-5">
                    <div class="p-4 border-bottom border-white border-opacity-10">
                        <h4 class="mb-0"><i class="fas fa-table me-2 text-primary"></i>Derni√®res mesures IoT</h4>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-custom table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Capteur</th>
                                    <th>CPU</th>
                                    <th>RAM</th>
                                    <th>Puissance</th>
                                    <th>Score √âco</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body">
                                <!-- Rempli dynamiquement -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Info Panel -->
    <div class="session-info hidden" id="sessionInfo">
        <div class="session-header">
            <div class="session-title">
                <i class="fas fa-user-shield me-2"></i>Session Active
            </div>
            <button class="session-close" onclick="hideSessionInfo()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="session-details">
            Utilisateur: <strong>{{ user.username }}</strong><br>
            Connect√© depuis: <span id="sessionStart">00:00:00</span><br>
            Statut: S√©curis√©
        </div>
        <div class="session-timer">
            <i class="fas fa-clock me-1"></i>
            Expiration automatique dans: <span id="sessionCountdown">30:00</span>
        </div>
    </div>

    <!-- Security Indicator -->
    <div class="security-indicator" onclick="showSessionInfo()" title="S√©curit√© de session">
        <i class="fas fa-shield-alt"></i>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/websocket-client.js' %}"></script>
    <script src="{% static 'js/main.js' %}"></script>
    <script>
        // ==================== SYST√àME DE NOTIFICATIONS ====================
        class NotificationSystem {
            constructor() {
                // Charger les notifications depuis localStorage
                const stored = localStorage.getItem('iot-notifications');
                if (stored) {
                    this.notifications = JSON.parse(stored);
                } else {
                    this.notifications = [];
                }
               
                this.maxMiniToasts = 3;
                this.maxNotifications = 50;
                this.miniToastDuration = 5000;
               
                // Cache pour √©viter les doublons
                this.notificationCache = new Map();
                this.cacheDuration = 300000; // 5 minutes
               
                this.init();
            }
            init() {
                this.updateNotificationBadge();
                this.setupEventListeners();
                this.renderStoredNotifications();
                this.loadNotificationCache();
            }
            loadNotificationCache() {
                const cached = localStorage.getItem('notification-cache');
                if (cached) {
                    try {
                        const cacheData = JSON.parse(cached);
                        const now = Date.now();
                       
                        for (const [key, timestamp] of Object.entries(cacheData)) {
                            if (now - timestamp < this.cacheDuration) {
                                this.notificationCache.set(key, timestamp);
                            }
                        }
                    } catch (e) {
                        console.error('Erreur de chargement du cache:', e);
                    }
                }
            }
            saveNotificationCache() {
                const cacheObj = Object.fromEntries(this.notificationCache);
                localStorage.setItem('notification-cache', JSON.stringify(cacheObj));
            }
            shouldShowNotification(type, value) {
                const cacheKey = `${type}-${Math.round(value)}`;
                const now = Date.now();
                const lastShown = this.notificationCache.get(cacheKey);
               
                if (lastShown && (now - lastShown < this.cacheDuration)) {
                    return false;
                }
               
                this.notificationCache.set(cacheKey, now);
                this.saveNotificationCache();
                return true;
            }
            cleanupNotificationCache() {
                const now = Date.now();
                for (const [key, timestamp] of this.notificationCache.entries()) {
                    if (now - timestamp > this.cacheDuration) {
                        this.notificationCache.delete(key);
                    }
                }
                this.saveNotificationCache();
            }
            setupEventListeners() {
                // Bouton de notification - rendu cliquable
                const notificationBtn = document.getElementById('notificationBtn');
                notificationBtn.style.cursor = 'pointer';
               
                notificationBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleNotificationsPanel();
                });
                // Bouton "Marquer tout comme lu"
                document.getElementById('clearAllBtn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.markAllAsRead();
                });
                // Fermer le panneau en cliquant en dehors
                document.addEventListener('click', (e) => {
                    const panel = document.getElementById('notificationsPanel');
                    const btn = document.getElementById('notificationBtn');
                   
                    if (panel.classList.contains('active') &&
                        !panel.contains(e.target) &&
                        !btn.contains(e.target)) {
                        panel.classList.remove('active');
                    }
                });
            }
            addNotification(type, title, message, value = null) {
                if (value !== null && !this.shouldShowNotification(type, value)) {
                    console.log(`Notification "${title}" ignor√©e (d√©j√† affich√©e r√©cemment)`);
                    return null;
                }
               
                const id = Date.now();
                const notification = {
                    id,
                    type,
                    title,
                    message,
                    value,
                    time: new Date().toLocaleTimeString('fr-FR', {
                        hour: '2-digit',
                        minute: '2-digit'
                    }),
                    timestamp: Date.now(),
                    read: false
                };
                this.notifications.unshift(notification);
                if (this.notifications.length > this.maxNotifications) {
                    this.notifications = this.notifications.slice(0, this.maxNotifications);
                }
                this.saveNotifications();
                this.updateNotificationBadge();
                this.renderMiniToast(notification);
                this.renderNotificationsList();
                return notification;
            }
            renderMiniToast(notification) {
                const container = document.getElementById('miniToastsContainer');
               
                const toast = document.createElement('div');
                toast.className = `mini-toast ${notification.type}`;
                toast.dataset.id = notification.id;
               
                toast.innerHTML = `
                    <div class="mini-toast-content">
                        <div class="mini-toast-icon">
                            <i class="fas ${this.getIconForType(notification.type)}"></i>
                        </div>
                        <div class="mini-toast-text">
                            <div class="mini-toast-title">${notification.title}</div>
                            <div class="mini-toast-message">${notification.message}</div>
                        </div>
                        <div class="mini-toast-time">${notification.time}</div>
                    </div>
                `;
                container.insertBefore(toast, container.firstChild);
                const toasts = container.querySelectorAll('.mini-toast');
                if (toasts.length > this.maxMiniToasts) {
                    toasts[toasts.length - 1].remove();
                }
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.style.opacity = '0';
                        toast.style.transform = 'translateX(100%)';
                        setTimeout(() => toast.remove(), 300);
                    }
                }, this.miniToastDuration);
                toast.addEventListener('click', () => {
                    this.markAsRead(notification.id);
                    toast.remove();
                });
            }
            renderStoredNotifications() {
                // Afficher les mini-toasts pour les notifications non lues
                const unreadNotifications = this.notifications
                    .filter(n => !n.read)
                    .slice(0, this.maxMiniToasts)
                    .reverse();
                unreadNotifications.forEach(notification => {
                    this.renderMiniToast(notification);
                });
                // Mettre √† jour la liste des notifications
                this.renderNotificationsList();
            }
            renderNotificationsList() {
                const list = document.getElementById('notificationsList');
                const count = document.getElementById('notificationCount');
               
                // Afficher TOUTES les notifications
                const allNotifications = this.notifications;
               
                // Mettre √† jour le compteur avec le nombre total de notifications
                count.textContent = allNotifications.length;
               
                // Afficher toutes les notifications, avec classe 'read' pour les lues
                list.innerHTML = allNotifications.map(notification => `
                    <div class="notification-item ${notification.type} ${notification.read ? 'read' : ''}" data-id="${notification.id}">
                        <div class="notification-item-header">
                            <div class="notification-item-title">
                                <i class="fas ${this.getIconForType(notification.type)} me-2"></i>
                                ${notification.title}
                            </div>
                            <div class="notification-item-time">${notification.time}</div>
                        </div>
                        <div class="notification-item-message">${notification.message}</div>
                    </div>
                `).join('');
               
                // Si aucune notification, afficher un message
                if (allNotifications.length === 0) {
                    list.innerHTML = `
                        <div class="text-center py-5 opacity-50">
                            <i class="fas fa-bell-slash fa-2x mb-3"></i>
                            <p>Aucune notification</p>
                        </div>
                    `;
                }
               
                // Ajouter les √©couteurs d'√©v√©nements
                list.querySelectorAll('.notification-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const id = parseInt(item.dataset.id);
                        this.markAsRead(id);
                       
                        // Fermer le panneau apr√®s avoir cliqu√© sur une notification
                        setTimeout(() => {
                            this.toggleNotificationsPanel();
                        }, 300);
                    });
                });
            }
            markAsRead(id) {
                const notification = this.notifications.find(n => n.id === id);
                if (notification) {
                    notification.read = true;
                    this.saveNotifications();
                    this.updateNotificationBadge();
                   
                    // Re-rendre la liste pour appliquer la classe 'read'
                    this.renderNotificationsList();
                }
            }
            markAllAsRead() {
                // Marquer toutes les notifications comme lues
                this.notifications.forEach(notification => {
                    notification.read = true;
                });
               
                this.saveNotifications();
                this.updateNotificationBadge();
                this.renderNotificationsList();
               
                // Effacer √©galement les mini-toasts
                document.getElementById('miniToastsContainer').innerHTML = '';
            }
            updateNotificationBadge() {
                const badge = document.getElementById('notificationBadge');
                const btn = document.getElementById('notificationBtn');
               
                if (!badge || !btn) return;
               
                // Compter uniquement les notifications non lues
                const unreadCount = this.notifications.filter(n => !n.read).length;
               
                if (unreadCount > 0) {
                    badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    badge.style.display = 'flex';
                    btn.classList.add('has-notifications');
                } else {
                    badge.style.display = 'none';
                    btn.classList.remove('has-notifications');
                }
            }
            toggleNotificationsPanel() {
                const panel = document.getElementById('notificationsPanel');
                const isActive = panel.classList.contains('active');
               
                if (!isActive) {
                    // Avant d'ouvrir, mettre √† jour la liste pour afficher les derni√®res notifications
                    this.renderNotificationsList();
                }
               
                panel.classList.toggle('active');
            }
            getIconForType(type) {
                switch(type) {
                    case 'danger': return 'fa-exclamation-circle';
                    case 'warning': return 'fa-triangle-exclamation';
                    case 'info': return 'fa-info-circle';
                    default: return 'fa-bell';
                }
            }
            saveNotifications() {
                // Sauvegarder dans localStorage
                localStorage.setItem('iot-notifications', JSON.stringify(this.notifications));
            }
        }

        // ==================== SYST√àME DE CHATBOT ====================
        class ChatbotSystem {
            constructor() {
                this.sessionId = this.generateSessionId();
                this.messages = [];
                this.apiUrl = 'http://37.59.116.54:8000/chat';
                
                this.init();
            }

            generateSessionId() {
                return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            init() {
                this.setupEventListeners();
                this.loadHistory();
            }

            setupEventListeners() {
                // Bouton d'ouverture du chatbot
                document.getElementById('chatbotBtn').addEventListener('click', () => {
                    this.toggleChatbot();
                });

                // Bouton de fermeture du chatbot
                document.getElementById('chatbotClose').addEventListener('click', () => {
                    this.toggleChatbot();
                });

                // Bouton d'envoi
                document.getElementById('chatbotSend').addEventListener('click', () => {
                    this.sendMessage();
                });

                // Suggestion de questions
                document.querySelectorAll('.suggestion-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const question = e.target.getAttribute('data-question');
                        document.getElementById('chatbotInput').value = question;
                        this.sendMessage();
                    });
                });

                // Entr√©e pour envoyer le message
                document.getElementById('chatbotInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });

                // Fermer le chatbot en cliquant en dehors
                document.addEventListener('click', (e) => {
                    const container = document.getElementById('chatbotContainer');
                    const btn = document.getElementById('chatbotBtn');
                    
                    if (container.classList.contains('active') && 
                        !container.contains(e.target) && 
                        !btn.contains(e.target)) {
                        container.classList.remove('active');
                    }
                });
            }

            toggleChatbot() {
                const container = document.getElementById('chatbotContainer');
                container.classList.toggle('active');
                
                if (container.classList.contains('active')) {
                    document.getElementById('chatbotInput').focus();
                    this.scrollToBottom();
                }
            }

            async sendMessage() {
                const input = document.getElementById('chatbotInput');
                const message = input.value.trim();
                
                if (!message) return;

                // Ajouter le message de l'utilisateur
                this.addMessage(message, 'user');
                input.value = '';

                // Afficher l'indicateur de frappe
                const typingIndicator = this.showTypingIndicator();

                try {
                    // Envoyer la requ√™te √† l'API
                    const response = await fetch(this.apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            session_id: this.sessionId,
                            message: message
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        
                        // Supprimer l'indicateur de frappe
                        typingIndicator.remove();
                        
                        // Ajouter la r√©ponse du bot
                        const botMessage = data.response || data.answer || "D√©sol√©, je n'ai pas pu obtenir de r√©ponse.";
                        this.addMessage(botMessage, 'bot');
                    } else {
                        throw new Error('Erreur de r√©ponse API');
                    }
                } catch (error) {
                    console.error('Erreur chatbot:', error);
                    
                    // Supprimer l'indicateur de frappe
                    typingIndicator.remove();
                    
                    // Afficher un message d'erreur
                    this.addMessage("D√©sol√©, je rencontre des difficult√©s techniques. Veuillez r√©essayer plus tard.", 'bot');
                }
            }

            addMessage(text, sender) {
                const messagesContainer = document.getElementById('chatbotMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                messageDiv.textContent = text;
                
                messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
                
                // Sauvegarder dans l'historique
                this.messages.push({ text, sender, timestamp: new Date().toISOString() });
                this.saveHistory();
            }

            showTypingIndicator() {
                const messagesContainer = document.getElementById('chatbotMessages');
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message bot typing';
                typingDiv.textContent = "L'assistant IA r√©fl√©chit...";
                typingDiv.id = 'typingIndicator';
                
                messagesContainer.appendChild(typingDiv);
                this.scrollToBottom();
                return typingDiv;
            }

            scrollToBottom() {
                const messagesContainer = document.getElementById('chatbotMessages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            saveHistory() {
                localStorage.setItem('chatbot-history', JSON.stringify({
                    sessionId: this.sessionId,
                    messages: this.messages
                }));
            }

            loadHistory() {
                const stored = localStorage.getItem('chatbot-history');
                if (stored) {
                    try {
                        const data = JSON.parse(stored);
                        this.sessionId = data.sessionId;
                        this.messages = data.messages;
                        
                        // Reconstruire l'interface
                        this.rebuildChat();
                    } catch (e) {
                        console.error('Erreur de chargement de l\'historique:', e);
                    }
                }
            }

            rebuildChat() {
                const messagesContainer = document.getElementById('chatbotMessages');
                messagesContainer.innerHTML = '';
                
                // Ajouter le message de bienvenue
                const welcomeMsg = document.createElement('div');
                welcomeMsg.className = 'message bot';
                welcomeMsg.textContent = 'Bonjour ! Je suis votre assistant IA EcoTrack. Comment puis-je vous aider aujourd\'hui ?';
                messagesContainer.appendChild(welcomeMsg);
                
                // Ajouter les messages de l'historique
                this.messages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.sender}`;
                    messageDiv.textContent = msg.text;
                    messagesContainer.appendChild(messageDiv);
                });
                
                this.scrollToBottom();
            }
        }

        // ==================== DASHBOARD IoT ====================
        const notificationSystem = new NotificationSystem();
        const chatbotSystem = new ChatbotSystem();
        
        let chartLabels = [], cpuData = [], ramData = [], powerData = [], ecoData = [], co2Data = [], latestData = [];
        const charts = {};
        // Seuils et notifications
        const thresholds = {
            cpu: {
                limit: 85,
                cmp: '>',
                title: 'CPU √©lev√©',
                message: v => `CPU ${v}% > 85%`,
                type: 'warning'
            },
            ram: {
                limit: 85,
                cmp: '>',
                title: 'RAM √©lev√©e',
                message: v => `RAM ${v}% > 85%`,
                type: 'warning'
            },
            power_watts: {
                limit: 200,
                cmp: '>',
                title: 'Puissance √©lev√©e',
                message: v => `Puissance ${v}W > 200W`,
                type: 'warning'
            },
            co2: {
                limit: 500,
                cmp: '>',
                title: 'CO‚ÇÇ √©lev√©',
                message: v => `CO‚ÇÇ ${v}g > 500g`,
                type: 'danger'
            },
            eco_score: {
                limit: 40,
                cmp: '<',
                title: 'Score √âco faible',
                message: v => `Score √âco ${v} < 40`,
                type: 'danger'
            }
        };
        // √âtat pr√©c√©dent pour d√©tecter les changements
        let previousState = {
            cpu: null,
            ram: null,
            power_watts: null,
            co2: null,
            eco_score: null
        };
        function checkThresholds(row) {
            if (!row) return;
           
            try {
                const cpu = Number(row.cpu_usage);
                const ram = Number(row.ram_usage);
                const pw = Number(row.power_watts);
                const eco = Number(row.eco_score);
                const co2 = Number(row.co2_equiv_g || (Array.isArray(co2Data) && co2Data.length ? co2Data[co2Data.length-1] : null));
               
                const checks = [
                    ['cpu', cpu],
                    ['ram', ram],
                    ['power_watts', pw],
                    ['eco_score', eco],
                    ['co2', co2]
                ];
               
                for (const [k, v] of checks) {
                    const conf = thresholds[k];
                    if (conf && compare(v, conf)) {
                        const previousValue = previousState[k];
                        const hasChanged = previousValue === null ||
                                          Math.abs(v - previousValue) > 5;
                       
                        if (hasChanged) {
                            previousState[k] = v;
                            notificationSystem.addNotification(
                                conf.type,
                                conf.title,
                                conf.message(v),
                                v
                            );
                        }
                    } else {
                        previousState[k] = null;
                    }
                }
            } catch(e) {
                console.error('Erreur dans checkThresholds:', e);
            }
        }
        function compare(val, conf) {
            if (val == null) return false;
            return conf.cmp === '>' ? (val > conf.limit) : (val < conf.limit);
        }
        function updateAverages() {
            const avg = arr => arr.length ? (arr.reduce((a,b) => a + b, 0) / arr.length).toFixed(1) : 0;
            document.getElementById('avg-cpu').textContent = avg(cpuData) + '%';
            document.getElementById('avg-ram').textContent = avg(ramData) + '%';
            document.getElementById('avg-power').textContent = avg(powerData) + ' W';
            document.getElementById('avg-eco').textContent = avg(ecoData);
        }
        function initCharts() {
            Object.values(charts).forEach(c => c.destroy());
            const baseOpts = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#e2e8f0',
                            font: { size: 12 }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: '#94a3b8',
                            maxRotation: 45
                        }
                    },
                    y: {
                        ticks: {
                            color: '#94a3b8'
                        },
                        grid: {
                            color: 'rgba(255,255,255,0.1)'
                        }
                    }
                }
            };
            charts.cpuRam = new Chart('cpuRamChart', {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [
                        {
                            label: 'CPU %',
                            data: cpuData,
                            borderColor: '#4361ee',
                            backgroundColor: 'rgba(67, 97, 238, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'RAM %',
                            data: ramData,
                            borderColor: '#a78bfa',
                            backgroundColor: 'rgba(167, 139, 250, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    ...baseOpts,
                    scales: {
                        ...baseOpts.scales,
                        y: {
                            ...baseOpts.scales.y,
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
            charts.energy = new Chart('energyChart', {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Watts',
                        data: powerData,
                        backgroundColor: 'rgba(245, 158, 11, 0.7)',
                        borderColor: '#f59e0b',
                        borderWidth: 1
                    }]
                },
                options: {
                    ...baseOpts,
                    scales: {
                        ...baseOpts.scales,
                        y: {
                            ...baseOpts.scales.y,
                            min: 0
                        }
                    }
                }
            });
            charts.eco = new Chart('ecoChart', {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Score √âco',
                        data: ecoData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    ...baseOpts,
                    scales: {
                        ...baseOpts.scales,
                        y: {
                            ...baseOpts.scales.y,
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
            charts.co2 = new Chart('co2Chart', {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'CO‚ÇÇ (g)',
                        data: co2Data,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    ...baseOpts,
                    scales: {
                        ...baseOpts.scales,
                        y: {
                            ...baseOpts.scales.y,
                            min: 0
                        }
                    }
                }
            });
        }
        function updateTable() {
            const tbody = document.getElementById('data-table-body');
            if (!tbody) return;
           
            tbody.innerHTML = latestData.length ? latestData.map(d => `
                <tr>
                    <td>${d.id}</td>
                    <td>${d.hardware_sensor_id}</td>
                    <td>${d.cpu_usage}%</td>
                    <td>${d.ram_usage}%</td>
                    <td>${d.power_watts}W</td>
                    <td><span class="badge-eco ${d.eco_score >= 75 ? 'bg-success' : d.eco_score >= 50 ? 'bg-warning' : 'bg-danger'}">${d.eco_score}</span></td>
                    <td>${new Date(d.created_at).toLocaleString('fr-FR')}</td>
                </tr>
            `).join('') : '<tr><td colspan="7" class="text-center py-5 opacity-50">Aucune donn√©e</td></tr>';
        }
        function updateTime() {
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString('fr-FR');
        }
        // Nettoyage p√©riodique du cache
        setInterval(() => {
            notificationSystem.cleanupNotificationCache();
        }, 60000);
        // Navigation cat√©gories
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const cat = btn.dataset.category;
                if (cat) window.location.href = `/api/${cat}/`;
            });
        });
        // Sidebar behavior
        const sidebar = document.getElementById('sidebar');
        const toggle = document.getElementById('sidebarToggle');
       
        function setExpanded(exp){
            sidebar.classList.toggle('expanded', !!exp);
            document.body.classList.toggle('sidebar-open', !!exp);
        }
       
        let expanded = false;
        toggle.addEventListener('click', () => {
            expanded = !expanded;
            setExpanded(expanded);
        });
       
        if(window.innerWidth >= 992){
            sidebar.addEventListener('mouseenter', () => { setExpanded(true); });
            sidebar.addEventListener('mouseleave', () => { setExpanded(false); });
        }
       
        window.addEventListener('resize', () => {
            if(window.innerWidth < 992){
                sidebar.removeEventListener('mouseenter', () => {});
                sidebar.removeEventListener('mouseleave', () => {});
                setExpanded(true);
            } else {
                sidebar.addEventListener('mouseenter', () => { setExpanded(true); });
                sidebar.addEventListener('mouseleave', () => { setExpanded(false); });
            }
        });
       
        if(window.innerWidth < 992){
            setExpanded(true);
        }

        // ==================== SYST√àME DE SESSION PROFESSIONNEL ====================
        class ProfessionalAuthSystem {
            constructor() {
                this.sessionDuration = 30 * 60 * 1000; // 30 minutes en millisecondes
                this.warningTime = 5 * 60 * 1000; // 5 minutes avant expiration
                this.sessionStartTime = Date.now();
                this.checkInterval = 60000; // V√©rifier chaque minute

                this.init();
            }

            init() {
                this.updateSessionDisplay();
                this.startSessionTimer();
                this.setupEventListeners();
                this.showWelcomeNotification();
            }

            updateSessionDisplay() {
                const now = new Date();
                document.getElementById('sessionStart').textContent = now.toLocaleTimeString('fr-FR');
                this.updateCountdown();
            }

            updateCountdown() {
                const elapsed = Date.now() - this.sessionStartTime;
                const remaining = Math.max(0, this.sessionDuration - elapsed);

                const minutes = Math.floor(remaining / (60 * 1000));
                const seconds = Math.floor((remaining % (60 * 1000)) / 1000);

                const countdownElement = document.getElementById('sessionCountdown');
                countdownElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                // Changer la couleur selon le temps restant
                if (remaining <= this.warningTime) {
                    countdownElement.style.color = '#ef4444';
                    countdownElement.previousElementSibling.style.color = '#ef4444';
                } else if (remaining <= 10 * 60 * 1000) { // 10 minutes
                    countdownElement.style.color = '#f59e0b';
                    countdownElement.previousElementSibling.style.color = '#f59e0b';
                }

                // Expiration automatique
                if (remaining <= 0) {
                    this.handleSessionExpiry();
                }
            }

            startSessionTimer() {
                setInterval(() => {
                    this.updateCountdown();
                }, 1000);

                // V√©rification p√©riodique de la session c√¥t√© serveur
                setInterval(() => {
                    this.checkSessionStatus();
                }, this.checkInterval);
            }

            async checkSessionStatus() {
                try {
                    const response = await fetch('/api/dashboard/', {
                        method: 'HEAD',
                        credentials: 'same-origin'
                    });

                    if (response.status === 401 || response.status === 403) {
                        this.handleSessionExpiry();
                    }
                } catch (error) {
                    console.warn('Erreur de v√©rification de session:', error);
                }
            }

            handleSessionExpiry() {
                // Afficher une notification d'expiration
                notificationSystem.addNotification(
                    'warning',
                    'Session expir√©e',
                    'Votre session a expir√©. Vous allez √™tre redirig√© vers la page de connexion.',
                    null
                );

                // Redirection apr√®s un d√©lai
                setTimeout(() => {
                    window.location.href = '/api/login/';
                }, 3000);
            }

            setupEventListeners() {
                // Activit√© utilisateur pour prolonger la session
                let activityTimeout;
                const resetActivityTimeout = () => {
                    clearTimeout(activityTimeout);
                    activityTimeout = setTimeout(() => {
                        this.extendSession();
                    }, 30000); // Reset apr√®s 30 secondes d'inactivit√©
                };

                ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
                    document.addEventListener(event, resetActivityTimeout, true);
                });

                resetActivityTimeout(); // Initialiser
            }

            extendSession() {
                // Ici on pourrait faire un appel AJAX pour prolonger la session c√¥t√© serveur
                console.log('Session prolong√©e par activit√© utilisateur');
            }

            showWelcomeNotification() {
                setTimeout(() => {
                    notificationSystem.addNotification(
                        'success',
                        'Connexion r√©ussie',
                        'Bienvenue dans votre tableau de bord EcoTrack IoT !',
                        null
                    );
                }, 1000);
            }
        }

        // Fonctions pour les contr√¥les de session
        function showSessionInfo() {
            document.getElementById('sessionInfo').classList.remove('hidden');
        }

        function hideSessionInfo() {
            document.getElementById('sessionInfo').classList.add('hidden');
        }

        // Initialiser le syst√®me d'authentification professionnel
        const authSystem = new ProfessionalAuthSystem();

        // Cacher le panneau de session en cliquant en dehors
        document.addEventListener('click', (e) => {
            const sessionInfo = document.getElementById('sessionInfo');
            const securityIndicator = document.querySelector('.security-indicator');

            if (!sessionInfo.contains(e.target) && !securityIndicator.contains(e.target)) {
                hideSessionInfo();
            }
        });
    </script>
</body>
</html>
