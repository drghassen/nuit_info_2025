{% extends 'iot/base.html' %}
{% load static %}

{% block title %}EcoTrack • Scores Éco{% endblock %}

{% block content %}
<div class="text-center mb-5">
    <h1 class="display-5 fw-bold mb-3">Scores <span class="text-primary">Écologiques</span></h1>
    <p class="lead opacity-80">Analyse des scores éco, obsolescence, dépendance et économies CO₂</p>
</div>

<div class="row g-4 mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="glass-card p-4 text-center">
            <i class="fas fa-leaf fa-2x text-success mb-3"></i>
            <p class="mb-1 opacity-75">Score Éco Moyen</p>
            <h3 class="metric-big text-success" id="avg-eco">-</h3>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="glass-card p-4 text-center">
            <i class="fas fa-clock fa-2x text-warning mb-3"></i>
            <p class="mb-1 opacity-75">Obsolescence Moyenne</p>
            <h3 class="metric-big text-warning" id="avg-obsolescence">-</h3>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="glass-card p-4 text-center">
            <i class="fas fa-building fa-2x text-danger mb-3"></i>
            <p class="mb-1 opacity-75">Dépendance BigTech</p>
            <h3 class="metric-big text-danger" id="avg-bigtech">-</h3>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="glass-card p-4 text-center">
            <i class="fas fa-seedling fa-2x text-success mb-3"></i>
            <p class="mb-1 opacity-75">Économies CO₂</p>
            <h3 class="metric-big text-success" id="avg-co2-savings">-</h3>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-lg-6">
        <div class="chart-container glass-card">
            <h5 class="mb-3"><i class="fas fa-leaf me-2 text-success"></i>Score Écologique</h5>
            <canvas id="ecoChart"></canvas>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="chart-container glass-card">
            <h5 class="mb-3"><i class="fas fa-clock me-2 text-warning"></i>Score d'Obsolescence</h5>
            <canvas id="obsolescenceChart"></canvas>
        </div>
    </div>
</div>
<div class="row g-4 mb-5">
    <div class="col-lg-6">
        <div class="chart-container glass-card">
            <h5 class="mb-3"><i class="fas fa-building me-2 text-danger"></i>Dépendance BigTech</h5>
            <canvas id="bigtechChart"></canvas>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="chart-container glass-card">
            <h5 class="mb-3"><i class="fas fa-seedling me-2 text-success"></i>Économies CO₂ (kg/an)</h5>
            <canvas id="co2SavingsChart"></canvas>
        </div>
    </div>
</div>

<div class="glass-card overflow-hidden">
    <div class="p-4 border-bottom border-white border-opacity-10">
        <h4 class="mb-0"><i class="fas fa-table me-2 text-primary"></i>Dernières Données de Scores</h4>
    </div>
    <div class="table-responsive">
        <table class="table table-custom table-hover mb-0">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Sensor ID</th>
                    <th>Score Éco</th>
                    <th>Obsolescence</th>
                    <th>BigTech</th>
                    <th>Économies CO₂</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="data-table-body">
                {% for data in latest_data %}
                <tr>
                    <td>{{ data.id }}</td>
                    <td>{{ data.hardware_sensor_id }}</td>
                    <td><span
                            class="badge {% if data.eco_score >= 75 %}bg-success{% elif data.eco_score >= 50 %}bg-warning{% else %}bg-danger{% endif %}">{{
                            data.eco_score }}</span></td>
                    <td>{{ data.obsolescence_score }}</td>
                    <td>{{ data.bigtech_dependency }}</td>
                    <td>{{ data.co2_savings_kg_year }} kg/an</td>
                    <td>{{ data.created_at|date:"d/m/Y H:i" }}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary"
                            onclick="showRecommendations('{{ data.recommendations|escapejs }}')"
                            title="Voir les recommandations">
                            <i class="fas fa-lightbulb"></i>
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="text-center py-5 opacity-50">Aucune donnée disponible</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Données pour JavaScript (cachées) -->
<script type="application/json" id="chart-labels-data">{{ chart_labels|safe }}</script>
<script type="application/json" id="eco-data">{{ eco_data|safe }}</script>
<script type="application/json" id="obsolescence-data">{{ obsolescence_data|safe }}</script>
<script type="application/json" id="bigtech-data">{{ bigtech_data|safe }}</script>
<script type="application/json" id="co2-savings-data">{{ co2_savings_data|safe }}</script>
<script type="application/json" id="latest-data-source">
[
    {% for data in latest_data %}
    {
        "id": {{ data.id }},
        "hardware_sensor_id": "{{ data.hardware_sensor_id }}",
        "eco_score": {{ data.eco_score }},
        "obsolescence_score": {{ data.obsolescence_score }},
        "bigtech_dependency": {{ data.bigtech_dependency }},
        "co2_savings_kg_year": {{ data.co2_savings_kg_year }},
        "created_at": "{{ data.created_at|date:'Y-m-d\TH:i:s' }}",
        "recommendations": {
            "eco": "{{ data.recommendations.eco|default:''|escapejs }}",
            "obsolescence": "{{ data.recommendations.obsolescence|default:''|escapejs }}",
            "dependency": "{{ data.recommendations.dependency|default:''|escapejs }}"
        }
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
]
</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/scores.js' %}?v=2.0"></script>
<script>
    function showRecommendations(recsData) {
        console.log('Raw recsData:', recsData);

        try {
            let recs = {};

            // Handle different input formats
            if (typeof recsData === 'string' && recsData.trim() !== '' && recsData !== '{}') {
                // Try to decode if it's URL-encoded (from JS dynamic render)
                try {
                    recs = JSON.parse(decodeURIComponent(recsData));
                } catch (e1) {
                    console.log('URL decode failed, trying direct parse');
                    try {
                        recs = JSON.parse(recsData);
                    } catch (e2) {
                        console.log('Direct parse failed, trying Python dict conversion');
                        // Try to parse Python dict format from Django template
                        // Convert Python dict format to JSON: {'key': 'value'} -> {"key": "value"}
                        // Handle emoji by being more careful with quotes
                        let fixed = recsData;

                        // Replace Python-style quotes with JSON-style
                        // Match key patterns: 'key':
                        fixed = fixed.replace(/'([^']+)':/g, '"$1":');
                        // Match string values: : 'value' (but not within values)
                        fixed = fixed.replace(/: '([^']*)'/g, ': "$1"');
                        // Handle remaining single quotes that might be in values
                        fixed = fixed.replace(/None/g, 'null');
                        fixed = fixed.replace(/True/g, 'true');
                        fixed = fixed.replace(/False/g, 'false');

                        console.log('Fixed string:', fixed);
                        recs = JSON.parse(fixed);
                    }
                }
            } else if (typeof recsData === 'object' && recsData !== null) {
                recs = recsData;
            }

            console.log('Parsed recs:', recs);

            const ecoContent = recs.eco || 'Aucune recommandation disponible.';
            const obsContent = recs.obsolescence || 'Aucune recommandation disponible.';
            const depContent = recs.dependency || 'Aucune recommandation disponible.';

            document.getElementById('rec-eco-content').textContent = ecoContent;
            document.getElementById('rec-obs-content').textContent = obsContent;
            document.getElementById('rec-dep-content').textContent = depContent;

            new bootstrap.Modal(document.getElementById('recommendationsModal')).show();
        } catch (e) {
            console.error('Erreur affichage recommandations:', e, 'Data:', recsData);
            // Show error in modal with debug info
            document.getElementById('rec-eco-content').textContent = 'Erreur de chargement';
            document.getElementById('rec-obs-content').textContent = 'Erreur de chargement';
            document.getElementById('rec-dep-content').textContent = 'Vérifiez la console pour plus de détails';
            new bootstrap.Modal(document.getElementById('recommendationsModal')).show();
        }
    }
</script>

<!-- Modal Recommandations -->
<div class="modal fade" id="recommendationsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-card border-0">
            <div class="modal-header border-bottom border-light border-opacity-10">
                <h5 class="modal-title"><i class="fas fa-clipboard-check me-2 text-primary"></i>Recommandations IA</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <h6 class="text-success mb-2"><i class="fas fa-leaf me-2"></i>Impact Écologique</h6>
                    <p class="text-light opacity-75 small" id="rec-eco-content">Chargement...</p>
                </div>
                <div class="mb-4">
                    <h6 class="text-warning mb-2"><i class="fas fa-clock me-2"></i>Obsolescence</h6>
                    <p class="text-light opacity-75 small" id="rec-obs-content">Chargement...</p>
                </div>
                <div>
                    <h6 class="text-danger mb-2"><i class="fas fa-building me-2"></i>Dépendance Tech</h6>
                    <p class="text-light opacity-75 small" id="rec-dep-content">Chargement...</p>
                </div>
            </div>
            <div class="modal-footer border-top border-light border-opacity-10">
                <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}